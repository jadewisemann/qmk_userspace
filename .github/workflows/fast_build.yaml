name: (TEST) Fast Build QMK Userspace

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 내 Userspace 저장소 (현재 저장소) 가져오기
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: userspace

    # 2. QMK 펌웨어 원본 가져오기 (가볍게)
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: jadewisemann/qmk_firmware
        ref: master
        path: qmk_firmware
        fetch-depth: 1
        submodules: recursive

    # 3. 파이썬 캐싱
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('qmk_firmware/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. 환경 설정 및 빌드 (여기가 핵심!)
    - name: Setup QMK & Mass Compile
      run: |
        # (1) QMK 설치
        python3 -m pip install --upgrade pip
        pip3 install qmk
        pip3 install -r qmk_firmware/requirements.txt
        
        # (2) Userspace 경로 연결
        # 내 userspace 폴더가 여기 있다고 QMK에게 알려줍니다.
        # 이렇게 하면 복사하지 않아도 알아서 인식합니다.
        echo "Setting up overlay directory..."
        cd qmk_firmware
        qmk config user.overlay_dir=$GITHUB_WORKSPACE/userspace

        # (3) 빌드 실행 (userspace-compile 대신 mass-compile 사용)
        # qmk.json 파일에 적힌 내용을 읽어서 빌드합니다.
        # userspace 폴더 안에 qmk.json이 있어야 합니다.
        echo "Compiling targets from qmk.json..."
        qmk mass-compile -c $GITHUB_WORKSPACE/userspace/qmk.json -j $(nproc)

        # (4) 결과물 이동
        mkdir ../firmware_outputs
        # 빌드된 파일들을 출력 폴더로 모음
        find . -name "*.hex" -exec cp {} ../firmware_outputs/ \;
        find . -name "*.bin" -exec cp {} ../firmware_outputs/ \;
        find . -name "*.uf2" -exec cp {} ../firmware_outputs/ \;

    # 5. 한국 시간 태그
    - name: Generate KST Date Tag
      id: tag
      run: |
        export TZ='Asia/Seoul'
        echo "release_tag=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

    # 6. 릴리즈 업로드
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Build ${{ steps.tag.outputs.release_date }} (KST)
        files: firmware_outputs/*
        draft: false
        prerelease: false