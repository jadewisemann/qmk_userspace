name: [TEST] Fast Build QMK Userspace

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 내 Userspace 저장소 가져오기
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: userspace

    # 2. QMK 펌웨어 가져오기 (Shallow Clone)
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: jadewisemann/qmk_firmware
        ref: master
        path: qmk_firmware
        fetch-depth: 1
        submodules: recursive

    # 3. 파이썬 캐싱
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('qmk_firmware/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. 환경 설정 및 Userspace 빌드 (수정됨)
    - name: Setup QMK & Userspace Compile
      run: |
        # (1) QMK 및 의존성 설치
        python3 -m pip install --upgrade pip
        pip3 install qmk
        pip3 install -r qmk_firmware/requirements.txt
        
        # (2) Userspace 경로 설정 (가장 중요!)
        # QMK CLI에게 "내 설정 파일은 userspace 폴더에 있어"라고 알려줍니다.
        # 이렇게 하면 qmk userspace-compile이 자동으로 qmk.json을 찾습니다.
        cd qmk_firmware
        export QMK_HOME=$(pwd)
        qmk config user.overlay_dir=$GITHUB_WORKSPACE/userspace

        # (3) Userspace 전용 빌드 실행
        # mass-compile 대신 제공해주신 문서에 있는 전용 명령어를 사용합니다.
        # -j $(nproc) 옵션으로 병렬 처리하여 속도를 높입니다.
        echo "Compiling targets defined in userspace/qmk.json..."
        qmk userspace-compile -j $(nproc)

        # (4) 결과물 이동
        mkdir ../firmware_outputs
        # 오류 방지를 위해 || true 추가
        find . -name "*.hex" -exec cp {} ../firmware_outputs/ \; 2>/dev/null || true
        find . -name "*.bin" -exec cp {} ../firmware_outputs/ \; 2>/dev/null || true
        find . -name "*.uf2" -exec cp {} ../firmware_outputs/ \; 2>/dev/null || true

    # 5. 한국 시간 태그
    - name: Generate KST Date Tag
      id: tag
      run: |
        export TZ='Asia/Seoul'
        echo "release_tag=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

    # 6. 릴리즈 업로드
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Build ${{ steps.tag.outputs.release_date }} (KST)
        files: firmware_outputs/*
        draft: false
        prerelease: false