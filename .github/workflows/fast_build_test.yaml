name: [TEST] Fastest Build (Docker + Shallow)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # [í•µì‹¬ 1] ì´ë¯¸ íˆ´ì´ ë‹¤ ì„¤ì¹˜ëœ QMK ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš© (ì„¤ì¹˜ ì‹œê°„ ì ˆì•½)
    container: ghcr.io/qmk/qmk_cli:latest

    steps:
    # 1. ê¶Œí•œ ë¬¸ì œ ë°©ì§€ (Docker ì‚¬ìš© ì‹œ í•„ìˆ˜)
    - name: Disable git safe directory checks
      run: git config --global --add safe.directory '*'

    # 2. ë‚´ Userspace ì €ìž¥ì†Œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: userspace

    # 3. QMK íŽŒì›¨ì–´ ê°€ì ¸ì˜¤ê¸° (ê°€ë³ê²Œ - Shallow Clone)
    # [í•µì‹¬ 2] DockerëŠ” ì“°ì§€ë§Œ, ë¬´ê±°ìš´ git ì—­ì‚¬ëŠ” ë°›ì§€ ì•ŠìŒ
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: jadewisemann/qmk_firmware
        ref: master
        path: qmk_firmware
        fetch-depth: 1
        submodules: recursive

    # 4. ì„¤ì • ë° ë¹Œë“œ (ì„¤ì¹˜ ê³¼ì • ì—†ìŒ!)
    - name: Setup & Userspace Compile
      run: |
        # ì»´íŒŒì¼ëŸ¬/PIP ì„¤ì¹˜ ë‹¨ê³„ê°€ ì•„ì˜ˆ í•„ìš” ì—†ìŒ (ì´ë¯¸ì§€ì— ë‹¤ ìžˆìŒ)
        
        # (1) Userspace ê²½ë¡œ ì„¤ì •
        cd qmk_firmware
        qmk config user.overlay_dir=$GITHUB_WORKSPACE/userspace

        # (2) ë¹Œë“œ ì‹¤í–‰
        echo "Compiling targets defined in userspace/qmk.json..."
        # ì—ëŸ¬ ë¬´ì‹œí•˜ê³  ì§„í–‰ (|| true)
        qmk userspace-compile -j $(nproc) || echo "âš ï¸ Build finished with exit code $?"

        # (3) ê²°ê³¼ë¬¼ ê³¨ë¼ ë‹´ê¸°
        echo "ðŸ” Filtering firmware files..."
        mkdir -p ../firmware_outputs
        
        # hex, uf2ë§Œ ì°¾ê³ , binê³¼ bootloader íŒŒì¼ì€ ì œì™¸
        find . -type f \
          \( -name "*.hex" -o -name "*.uf2" \) \
          -not -name "*.bin" \
          -not -name "*bootloader*" \
          -exec cp {} ../firmware_outputs/ \;

    # 5. í•œêµ­ ì‹œê°„ íƒœê·¸ (Docker ì•ˆì—ëŠ” date ëª…ë ¹ì–´ê°€ ë‹¤ë¥¼ ìˆ˜ ìžˆì–´ì„œ TZ ì²˜ë¦¬ ì£¼ì˜)
    - name: Generate KST Date Tag
      id: tag
      run: |
        # ì•ŒíŒŒì¸ ë¦¬ëˆ…ìŠ¤ë‚˜ ë°ë¹„ì•ˆ ìŠ¬ë¦¼ì¼ ìˆ˜ ìžˆì–´ì„œ TZ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì—†ì´ ì‹œê°„ ê³„ì‚°
        # ê·¸ëƒ¥ UTCì— 9ì‹œê°„ ë”í•˜ëŠ” ë°©ì‹ì´ ê°€ìž¥ ì•ˆì „í•¨, í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨ížˆ TZ ì„¤ì • ì‹œë„
        export TZ='Asia/Seoul'
        
        # ë‚ ì§œ í¬ë§·íŒ…
        echo "release_tag=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

    # 6. ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œ
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Build ${{ steps.tag.outputs.release_date }} (KST)
        files: firmware_outputs/*
        draft: false
        prerelease: false