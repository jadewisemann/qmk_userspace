name: (TEST) Fast Build QMK Userspace

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. ë‚´ Userspace ì €ìž¥ì†Œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: userspace

    # 2. QMK íŽŒì›¨ì–´ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: jadewisemann/qmk_firmware
        ref: master
        path: qmk_firmware
        fetch-depth: 1
        submodules: recursive

    # 3. [í•µì‹¬] ì»´íŒŒì¼ëŸ¬ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (ì´ê²Œ ë¹ ì ¸ì„œ íŒŒì¼ì´ ì•ˆ ìƒê¸´ ê²ƒìž„)
    - name: Install Compilers & Tools
      run: |
        sudo apt-get update
        # AVR(Pro Micro ë“±)ê³¼ ARM(RP2040, STM32 ë“±) ì»´íŒŒì¼ëŸ¬ ëª¨ë‘ ì„¤ì¹˜
        sudo apt-get install -y \
          build-essential \
          gcc-avr avr-libc \
          gcc-arm-none-eabi libnewlib-arm-none-eabi \
          git dfu-programmer dfu-util

    # 4. íŒŒì´ì¬ ìºì‹±
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('qmk_firmware/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 5. í™˜ê²½ ì„¤ì • ë° Userspace ë¹Œë“œ
    - name: Setup QMK & Userspace Compile
      run: |
        # (1) QMK íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
        python3 -m pip install --upgrade pip
        pip3 install qmk
        pip3 install -r qmk_firmware/requirements.txt
        
        # (2) Userspace ê²½ë¡œ ì„¤ì •
        cd qmk_firmware
        export QMK_HOME=$(pwd)
        qmk config user.overlay_dir=$GITHUB_WORKSPACE/userspace

        # (3) ë¹Œë“œ ì‹¤í–‰
        echo "Compiling targets defined in userspace/qmk.json..."
        # ì»´íŒŒì¼ëŸ¬ê°€ ì„¤ì¹˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì œ ì§„ì§œ íŒŒì¼ì´ ìƒê¹ë‹ˆë‹¤.
        qmk userspace-compile -j $(nproc) || echo "âš ï¸ Build finished with exit code $?"

        # (4) ê²°ê³¼ë¬¼ ì°¾ì•„ì„œ ì´ë™
        echo "ðŸ” Searching for firmware files recursively..."
        mkdir -p ../firmware_outputs
        
        # íŒŒì¼ ì°¾ê¸° ë° ë³µì‚¬
        find . -type f \( -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -print -exec cp {} ../firmware_outputs/ \;

    # 6. í•œêµ­ ì‹œê°„ íƒœê·¸
    - name: Generate KST Date Tag
      id: tag
      run: |
        export TZ='Asia/Seoul'
        echo "release_tag=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

    # 7. ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œ
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Build ${{ steps.tag.outputs.release_date }} (KST)
        files: firmware_outputs/*
        draft: false
        prerelease: false