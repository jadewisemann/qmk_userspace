name: (TEST) Fast Build QMK Userspace

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 내 Userspace 저장소 가져오기
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: userspace

    # 2. QMK 펌웨어 가져오기 (Shallow Clone)
    - name: Checkout QMK Firmware
      uses: actions/checkout@v4
      with:
        repository: jadewisemann/qmk_firmware
        ref: master
        path: qmk_firmware
        fetch-depth: 1
        submodules: recursive

    # 3. 파이썬 캐싱
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('qmk_firmware/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. 환경 설정 및 Userspace 빌드 (Fail-safe 버전)
      - name: Setup QMK & Userspace Compile
        run: |
          # (1) QMK 및 의존성 설치
          python3 -m pip install --upgrade pip
          pip3 install qmk
          pip3 install -r qmk_firmware/requirements.txt
          
          # (2) Userspace 경로 설정
          cd qmk_firmware
          export QMK_HOME=$(pwd)
          qmk config user.overlay_dir=$GITHUB_WORKSPACE/userspace

          # (3) Userspace 전용 빌드 실행
          echo "Compiling targets defined in userspace/qmk.json..."
          # [중요] || echo "..." 를 붙여서, 컴파일러가 1을 반환해도 스크립트가 죽지 않게 방어합니다.
          qmk userspace-compile -j $(nproc) || echo "⚠️ Compliation finished with non-zero exit code (but likely successful)"

          # (4) 결과물 이동 (더 단순하고 강력한 방식)
          echo "Moving firmware files..."
          mkdir -p ../firmware_outputs
          
          # 빌드 결과물은 보통 루트나 .build 폴더에 생깁니다. 양쪽 다 뒤져서 복사합니다.
          # || true를 붙여서 파일이 없어도 에러가 나지 않게 합니다.
          cp *.hex ../firmware_outputs/ 2>/dev/null || true
          cp *.bin ../firmware_outputs/ 2>/dev/null || true
          cp *.uf2 ../firmware_outputs/ 2>/dev/null || true
          cp .build/*.hex ../firmware_outputs/ 2>/dev/null || true
          cp .build/*.bin ../firmware_outputs/ 2>/dev/null || true
          cp .build/*.uf2 ../firmware_outputs/ 2>/dev/null || true

          # (5) 파일 확인 (디버깅용 로그)
          echo "✅ Check copied files:"
          ls -l ../firmware_outputs/
          
    # 5. 한국 시간 태그
    - name: Generate KST Date Tag
      id: tag
      run: |
        export TZ='Asia/Seoul'
        echo "release_tag=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

    # 6. 릴리즈 업로드
    - name: Create Release and Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Build ${{ steps.tag.outputs.release_date }} (KST)
        files: firmware_outputs/*
        draft: false
        prerelease: false